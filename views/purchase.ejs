<%- include('partials/head') %>
<body class="bg-gray-900 text-white min-h-screen flex flex-col justify-between">

  <!-- Navbar -->
    <%- include('partials/navbar') %>

      <!-- Header -->
        <header class="p-6 text-center">
            <h1 class="text-3xl font-bold mb-2">Purchase FREP Token</h1>
                <p class="text-gray-400">Connect your wallet to start buying</p>
                  </header>

                    <!-- Wallet Connect Section -->
                      <main class="flex-1 flex flex-col items-center justify-center p-6 space-y-6">

                          <!-- Wallet Buttons -->
                              <div id="wallet-section" class="mb-6">
                                    <button id="connect-btn" class="px-6 py-3 bg-indigo-600 rounded-xl hover:bg-indigo-700">Connect Wallet</button>
                                          <button id="disconnect-btn" class="hidden px-6 py-3 bg-red-600 rounded-xl hover:bg-red-700 ml-3">Disconnect</button>
                                              </div>

                                                  <!-- Network Switch -->
                                                      <div id="network-switch" class="hidden mb-6">
                                                            <label for="network" class="mr-2">Switch Network:</label>
                                                                  <select id="network" class="bg-gray-800 px-3 py-2 rounded">
                                                                          <option value="mainnet-beta">Mainnet</option>
                                                                                  <option value="devnet" selected>Devnet</option>
                                                                                          <option value="testnet">Testnet</option>
                                                                                                </select>
                                                                                                    </div>

                                                                                                        <!-- Calculator -->
                                                                                                            <div class="bg-gray-800 rounded-2xl p-6 shadow-lg w-full max-w-md">
                                                                                                                  <div class="flex justify-center space-x-6 mb-4">
                                                                                                                          <button class="currency-btn" data-symbol="SOL">
                                                                                                                                    <img src="/img/sol.png" alt="SOL" class="h-8 inline"> SOL
                                                                                                                                            </button>
                                                                                                                                                    <button class="currency-btn" data-symbol="USDT">
                                                                                                                                                              <img src="/img/usdt.png" alt="USDT" class="h-8 inline"> USDT
                                                                                                                                                                      </button>
                                                                                                                                                                              <button class="currency-btn" data-symbol="USDC">
                                                                                                                                                                                        <img src="/img/usdc.png" alt="USDC" class="h-8 inline"> USDC
                                                                                                                                                                                                </button>
                                                                                                                                                                                                      </div>
                                                                                                                                                                                                            <div class="text-center mb-2">
                                                                                                                                                                                                                    <p id="token-symbol" class="text-xl font-semibold">FREP = 0.001$</p>
                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                <div class="flex items-center justify-between mb-4">
                                                                                                                                                                                                                                        <input id="amount" type="number" min="0" placeholder="Amount" class="flex-1 px-3 py-2 rounded bg-gray-700 text-white">
                                                                                                                                                                                                                                                <span class="ml-3">≈ <span id="usd-value">0</span> $</span>
                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                            <button id="buy-btn" class="w-full px-6 py-3 bg-green-600 rounded-xl hover:bg-green-700 disabled:opacity-50" disabled>Buy Now</button>
                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                  </main>

                                                                                                                                                                                                                                                                    <!-- Footer -->
                                                                                                                                                                                                                                                                      <footer class="bg-gray-800 py-4 text-center">
                                                                                                                                                                                                                                                                          <div class="flex justify-center space-x-6 mb-2">
                                                                                                                                                                                                                                                                                <a href="#" class="hover:text-indigo-400">X</a>
                                                                                                                                                                                                                                                                                      <a href="#" class="hover:text-indigo-400">Telegram</a>
                                                                                                                                                                                                                                                                                            <a href="#" class="hover:text-indigo-400">TikTok</a>
                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                    <div>
                                                                                                                                                                                                                                                                                                          <a href="/airdrop" class="text-indigo-400 hover:underline">Airdrop</a>
                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                </footer>

                                                                                                                                                                                                                                                                                                                  <!-- Wallet Adapter -->
                                                                                                                                                                                                                                                                                                                    <script type="module">
                                                                                                                                                                                                                                                                                                                        import {
                                                                                                                                                                                                                                                                                                                              Connection,
                                                                                                                                                                                                                                                                                                                                    PublicKey,
                                                                                                                                                                                                                                                                                                                                          clusterApiUrl,
                                                                                                                                                                                                                                                                                                                                                Transaction,
                                                                                                                                                                                                                                                                                                                                                      SystemProgram
                                                                                                                                                                                                                                                                                                                                                          } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/+esm";

                                                                                                                                                                                                                                                                                                                                                              import {
                                                                                                                                                                                                                                                                                                                                                                    WalletAdapterNetwork
                                                                                                                                                                                                                                                                                                                                                                        } from "https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-base@0.9.23/+esm";

                                                                                                                                                                                                                                                                                                                                                                            import {
                                                                                                                                                                                                                                                                                                                                                                                  PhantomWalletAdapter
                                                                                                                                                                                                                                                                                                                                                                                      } from "https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-phantom@0.9.23/+esm";

                                                                                                                                                                                                                                                                                                                                                                                          import {
                                                                                                                                                                                                                                                                                                                                                                                                SolflareWalletAdapter
                                                                                                                                                                                                                                                                                                                                                                                                    } from "https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-solflare@0.9.23/+esm";

                                                                                                                                                                                                                                                                                                                                                                                                        // UI Elements
                                                                                                                                                                                                                                                                                                                                                                                                            const connectBtn = document.getElementById('connect-btn');
                                                                                                                                                                                                                                                                                                                                                                                                                const disconnectBtn = document.getElementById('disconnect-btn');
                                                                                                                                                                                                                                                                                                                                                                                                                    const buyBtn = document.getElementById('buy-btn');
                                                                                                                                                                                                                                                                                                                                                                                                                        const amountInput = document.getElementById('amount');
                                                                                                                                                                                                                                                                                                                                                                                                                            const usdValue = document.getElementById('usd-value');
                                                                                                                                                                                                                                                                                                                                                                                                                                const networkSelect = document.getElementById('network');

                                                                                                                                                                                                                                                                                                                                                                                                                                    let wallet = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                        let connection = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                            let publicKey = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                let currentCurrency = "SOL";

                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Prices (mock, ممكن تربط API CoinGecko)
                                                                                                                                                                                                                                                                                                                                                                                                                                                        const prices = { SOL: 20, USDT: 1, USDC: 1 };

                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Currency buttons
                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.querySelectorAll('.currency-btn').forEach(btn => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      btn.addEventListener('click', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              currentCurrency = btn.dataset.symbol;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      calculate();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    amountInput.addEventListener('input', calculate);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function calculate() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const amount = parseFloat(amountInput.value) || 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    usdValue.textContent = (amount * prices[currentCurrency]).toFixed(2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Connect wallet
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                connectBtn.addEventListener('click', async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const network = networkSelect.value || "devnet";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            connection = new Connection(clusterApiUrl(network), "confirmed");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Wallet list
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const phantom = new PhantomWalletAdapter();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const solflare = new SolflareWalletAdapter();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // إذا Phantom متاح
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (phantom.readyState === "Installed") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  wallet = phantom;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                wallet = solflare;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await wallet.connect();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            publicKey = wallet.publicKey;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log("Connected:", publicKey.toBase58());

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            connectBtn.classList.add("hidden");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    disconnectBtn.classList.remove("hidden");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById("network-switch").classList.remove("hidden");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    buyBtn.disabled = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  console.error("Wallet connection failed", err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                disconnectBtn.addEventListener("click", async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (wallet) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await wallet.disconnect();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          publicKey = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                connectBtn.classList.remove("hidden");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      disconnectBtn.classList.add("hidden");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById("network-switch").classList.add("hidden");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  buyBtn.disabled = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Buy
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              buyBtn.addEventListener("click", async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!wallet || !publicKey) return alert("Connect wallet first!");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const amount = parseFloat(amountInput.value);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!amount || amount <= 0) return alert("Enter valid amount");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const lamports = amount * 1e9; // 1 SOL = 1e9 lamports
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const merchant = new PublicKey("<%= SITE.merchant %>");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const tx = new Transaction().add(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          SystemProgram.transfer({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fromPubkey: publicKey,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              toPubkey: merchant,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        lamports
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const { blockhash } = await connection.getLatestBlockhash();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tx.recentBlockhash = blockhash;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tx.feePayer = publicKey;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const signed = await wallet.signTransaction(tx);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const sig = await connection.sendRawTransaction(signed.serialize());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log("Transaction sent:", sig);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    alert("Success! View on Explorer:\nhttps://explorer.solana.com/tx/" + sig + "?cluster=" + networkSelect.value);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  console.error("Transaction failed", err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          alert("Transaction failed: " + err.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </html>